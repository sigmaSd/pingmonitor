<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ping Graph</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --bg-color: #f5f5f7;
        --chart-bg: #ffffff;
        --text-color: #333333;
        --grid-color: rgba(0, 0, 0, 0.1);
        --chart-border: rgba(75, 192, 192, 1);
        --chart-fill: rgba(75, 192, 192, 0.2);
        --toggle-bg: #e0e0e0;
        --header-bg: #ffffff;
        --header-border: #e0e0e0;
      }

      :root.dark-theme {
        --bg-color: #121212;
        --chart-bg: #1e1e1e;
        --text-color: #e0e0e0;
        --grid-color: rgba(255, 255, 255, 0.1);
        --chart-border: rgba(75, 192, 255, 1);
        --chart-fill: rgba(75, 192, 255, 0.2);
        --toggle-bg: #333333;
        --header-bg: #1e1e1e;
        --header-border: #333333;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        background-color: var(--bg-color);
        color: var(--text-color);
        transition: background-color 0.3s, color 0.3s;
        overflow-y: auto;
        overflow-x: hidden;
      }

      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1.5rem;
        background-color: var(--header-bg);
        border-bottom: 1px solid var(--header-border);
        flex-shrink: 0;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        z-index: 10;
      }

      .title-section h1 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        letter-spacing: 0.5px;
      }

      .stats-container {
        display: flex;
        gap: 2rem;
        font-size: 0.9rem;
      }

      .stat-box {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .stat-label {
        opacity: 0.6;
        font-weight: 500;
      }

      .stat-value {
        font-weight: 600;
        font-family: "Consolas", "Monaco", monospace;
        font-size: 1.5rem;
      }

      .chart-area {
        flex-grow: 1;
        position: relative;
        width: 100%;
        padding: 1rem;
        min-height: 300px;
      }

      .chart-wrapper {
        position: relative;
        width: 100%;
        height: 100%;
      }

      .theme-toggle {
        cursor: pointer;
        font-size: 1.1rem;
        background: none;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        outline: none;
        background-color: var(--toggle-bg);
        color: var(--text-color);
      }

      .theme-toggle:hover {
        background-color: var(--chart-border);
        color: white;
        transform: scale(1.05);
      }

      @media (max-width: 600px) {
        .top-bar {
          flex-wrap: wrap;
          gap: 10px;
        }
        .stats-container {
          order: 3;
          width: 100%;
          justify-content: space-between;
          gap: 10px;
          padding-top: 10px;
          border-top: 1px solid var(--header-border);
        }
      }
    </style>
  </head>
  <body>
    <header class="top-bar">
      <div class="title-section">
        <h1>Ping Monitor</h1>
      </div>

      <div class="stats-container">
        <div class="stat-box">
          <span class="stat-label">Current</span>
          <span class="stat-value" id="currentPing">-- ms</span>
        </div>
        <div class="stat-box">
          <span class="stat-label">Avg</span>
          <span class="stat-value" id="avgPing">-- ms</span>
        </div>
        <div class="stat-box">
          <span class="stat-label">Max</span>
          <span class="stat-value" id="maxPing">-- ms</span>
        </div>
      </div>

      <button
        class="theme-toggle"
        id="themeToggle"
        title="Toggle dark/light mode"
      >
        ‚òÄÔ∏è
      </button>
    </header>

    <main class="chart-area">
      <div class="chart-wrapper">
        <canvas id="pingChart"></canvas>
      </div>
    </main>

    <script>
      const ws = new WebSocket("ws://" + window.location.host);
      const ctx = document.getElementById("pingChart").getContext("2d");
      const themeToggle = document.getElementById("themeToggle");
      let pingValues = [];
      const MAX_DATA_POINTS = 60;
      const REMOVE_CHUNK_SIZE = 10; // Remove 10 points at once when needed

      let lastReceivedTime = Date.now();
      const PING_INTERVAL = 1000;

      // Check if running in Webview context
      const isWebview = typeof window.getInitialTheme === "function";
      let darkMode = window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      // Function to initialize theme
      async function initializeTheme() {
        // If in Webview, get theme from the app storage
        if (isWebview) {
          try {
            const savedTheme = await window.getInitialTheme();
            if (savedTheme) {
              darkMode = savedTheme === "dark";
            }
          } catch (e) {
            console.error("Error getting theme from Webview:", e);
          }
        } else {
          // Browser mode - use localStorage
          const savedTheme = localStorage.getItem("theme");
          if (savedTheme) {
            darkMode = savedTheme === "dark";
          }
        }

        // Apply theme
        document.documentElement.classList.toggle(
          "dark-theme",
          darkMode,
        );
        themeToggle.textContent = darkMode ? "üåô" : "‚òÄÔ∏è";
        updateChartTheme();
      }

      // Call theme initialization
      initializeTheme();

      // Theme toggle functionality
      themeToggle.addEventListener("click", () => {
        darkMode = !darkMode;
        const themeValue = darkMode ? "dark" : "light";

        document.documentElement.classList.toggle(
          "dark-theme",
          darkMode,
        );
        themeToggle.textContent = darkMode ? "üåô" : "‚òÄÔ∏è";

        // Save theme preference
        if (isWebview) {
          // Save in Webview's backend
          try {
            window.saveTheme(themeValue);
          } catch (e) {
            console.error("Error saving theme in Webview:", e);
          }
        } else {
          // Save in browser's localStorage
          localStorage.setItem("theme", themeValue);
        }

        updateChartTheme();
      });

      // Set up Chart.js with theme-aware colors
      const chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [{
            label: "Ping (ms)",
            data: [],
            borderColor: "rgba(75, 192, 192, 1)", // Default color
            backgroundColor: "rgba(75, 192, 192, 0.2)",
            borderWidth: 2,
            fill: true,
            tension: 0.2,
            pointRadius: 3, // Show points
          }],
        },
        options: {
          animation: {
            duration: 600,
            easing: "easeOutQuad",
          },
          responsive: true,
          maintainAspectRatio: false, // CHANGED: Allow filling the container
          interaction: {
            intersect: false,
            mode: "index",
          },
          scales: {
            y: {
              beginAtZero: false, // Better for ping
              grace: "5%",
              grid: {
                color: darkMode
                  ? "rgba(255, 255, 255, 0.05)"
                  : "rgba(0, 0, 0, 0.05)",
              },
              ticks: {
                color: darkMode ? "#e0e0e0" : "#333333",
                font: {
                  size: 14,
                },
              },
            },
            x: {
              grid: {
                display: false, // Cleaner look
                color: darkMode
                  ? "rgba(255, 255, 255, 0.05)"
                  : "rgba(0, 0, 0, 0.05)",
              },
              ticks: {
                color: darkMode ? "#e0e0e0" : "#333333",
                maxRotation: 0,
                autoSkip: true,
                maxTicksLimit: 8,
                font: {
                  size: 14,
                },
              },
            },
          },
          plugins: {
            legend: {
              display: false, // Hide legend for cleaner look since there is only 1 dataset
              labels: {
                color: darkMode ? "#e0e0e0" : "#333333",
                font: {
                  size: 14,
                },
              },
            },
            tooltip: {
              backgroundColor: darkMode
                ? "rgba(30, 30, 30, 0.9)"
                : "rgba(255, 255, 255, 0.9)",
              titleColor: darkMode ? "#ffffff" : "#000000",
              bodyColor: darkMode ? "#e0e0e0" : "#333333",
              borderColor: darkMode
                ? "rgba(255, 255, 255, 0.1)"
                : "rgba(0, 0, 0, 0.1)",
              borderWidth: 1,
              padding: 10,
              cornerRadius: 8,
              displayColors: false,
            },
          },
        },
      });

      // Listen for system theme changes (browser-only)
      if (!isWebview && window.matchMedia) {
        window.matchMedia("(prefers-color-scheme: dark)")
          .addEventListener("change", (e) => {
            // Only apply system theme if no manual preference is set
            const hasStoredPreference =
              localStorage.getItem("theme") !== null;
            if (!hasStoredPreference) {
              darkMode = e.matches;
              document.documentElement.classList.toggle(
                "dark-theme",
                darkMode,
              );
              themeToggle.textContent = darkMode ? "üåô" : "‚òÄÔ∏è";
              updateChartTheme();
            }
          });
      }

      function updateChartTheme() {
        const gridColor = darkMode
          ? "rgba(255, 255, 255, 0.05)"
          : "rgba(0, 0, 0, 0.05)";

        chart.data.datasets[0].borderColor = darkMode
          ? "rgba(75, 192, 255, 1)"
          : "rgba(75, 192, 192, 1)";
        document.getElementById("currentPing").style.color = chart.data
          .datasets[0].borderColor;
        chart.data.datasets[0].backgroundColor = darkMode
          ? "rgba(75, 192, 255, 0.1)" // More transparent fill
          : "rgba(75, 192, 192, 0.1)";
        chart.options.scales.y.grid.color = gridColor;
        chart.options.scales.x.grid.color = gridColor;
        chart.options.scales.y.ticks.color = darkMode
          ? "#e0e0e0"
          : "#333333";
        chart.options.scales.x.ticks.color = darkMode
          ? "#e0e0e0"
          : "#333333";
        chart.options.plugins.legend.labels.color = darkMode
          ? "#e0e0e0"
          : "#333333";
        chart.options.plugins.tooltip.backgroundColor = darkMode
          ? "rgba(30, 30, 30, 0.9)"
          : "rgba(255, 255, 255, 0.9)";
        chart.options.plugins.tooltip.titleColor = darkMode
          ? "#ffffff"
          : "#000000";
        chart.options.plugins.tooltip.bodyColor = darkMode
          ? "#e0e0e0"
          : "#333333";
        chart.options.plugins.tooltip.borderColor = darkMode
          ? "rgba(255, 255, 255, 0.1)"
          : "rgba(0, 0, 0, 0.1)";
        chart.update();
      }

      function updateStats() {
        if (pingValues.length > 0) {
          const currentPing = pingValues[pingValues.length - 1];
          const avgPing = (pingValues.reduce((a, b) =>
            a + b, 0) / pingValues.length).toFixed(1);
          const maxPing = Math.max(...pingValues);

          document.getElementById("currentPing").textContent =
            `${currentPing} ms`;
          document.getElementById("avgPing").textContent =
            `${avgPing} ms`;
          document.getElementById("maxPing").textContent =
            `${maxPing} ms`;
        }
      }

      function addDataPoint(timeString, pingValue) {
        chart.data.labels.push(timeString);
        chart.data.datasets[0].data.push(pingValue);
        pingValues.push(pingValue);

        if (chart.data.labels.length > MAX_DATA_POINTS) {
          chart.data.labels = chart.data.labels.slice(
            REMOVE_CHUNK_SIZE,
          );
          chart.data.datasets[0].data = chart.data.datasets[0].data
            .slice(REMOVE_CHUNK_SIZE);
          pingValues = pingValues.slice(REMOVE_CHUNK_SIZE);
        }
      }

      // WebSocket message handling
      ws.onmessage = function (event) {
        try {
          const data = JSON.parse(event.data);
          const now = new Date();
          const timeString = now.toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });

          addDataPoint(timeString, data.ping);
          updateStats();
          lastReceivedTime = Date.now();
          const newColor = darkMode
            ? "rgba(75, 192, 255, 1)"
            : "rgba(75, 192, 192, 1)";
          chart.data.datasets[0].borderColor = newColor; // Reset to default color
          document.getElementById("currentPing").style.color = newColor;
          chart.update();
        } catch (e) {
          console.error("Error processing ping data:", e);
        }
      };

      ws.onclose = function (event) {
        console.log("WebSocket connection closed, reconnecting...");
        chart.data.datasets[0].borderColor = "#ff6b6b"; // Soft red
        document.getElementById("currentPing").style.color = "#ff6b6b";
      };

      ws.onerror = function (error) {
        console.error("WebSocket error:", error);
        chart.data.datasets[0].borderColor = "#ff6b6b";
        document.getElementById("currentPing").style.color = "#ff6b6b";
        chart.update(); // immediate
      };

      setInterval(() => {
        if (ws.readyState === WebSocket.OPEN) {
          const currentTime = Date.now();
          const timeSinceLastPing = currentTime - lastReceivedTime;

          if (timeSinceLastPing >= PING_INTERVAL) {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
            });
            addDataPoint(timeString, 0);

            // Change line color to red if disconnected
            chart.data.datasets[0].borderColor = "#ff6b6b";
            document.getElementById("currentPing").style.color = "#ff6b6b";

            chart.update();
            lastReceivedTime = currentTime; // Treat this as a "received" point
          }
        }
      }, PING_INTERVAL);
    </script>
  </body>
</html>
